/*! komponentor v1.0.0
 * A jQuery plugin to create modular web apps
 * (c) 2026
 * Released under the MIT License
 */

(()=>{/*!
 * Komponentor (single-file)
 * - Tree of components (parent/children), local scan
 * - Destroy cascades
 * - Optional hash router
 * - jQuery optional (used only as helper if present)
 *
 * Public API (minimal):
 *   komponentor.root(host, urlOrOpts)
 *   komponentor.mount(host, urlOrOpts)
 *   komponentor.scan(container?, { parent?, replaceExisting? })
 *   komponentor.route({ outlet, routes, notFound })
 *   komponentor.navigate(hash)
 *   komponentor.intent(urlOrOpts)  -> fluent .data(...).send({ parent })
 *   komponentor.runIntent(url, data, { parent })
 *
 * Component marker:
 *   <div data-komponent="/path/to/component.html|id=5|foo=bar"></div>
 *
 * Intent usage examples:
 *   // From a component (intent becomes part of the branch; destroyed when parent is destroyed)
 *   async function init_komponent(k, data) {
 *     const i = await komponentor.intent("modal.html|id=1").data({ source: k }).send({ parent: k });
 *     // i.ctx.ready, i.data; i may mount DOM via komponentor.mount(...) inside modal's init
 *   }
 *
 *   // Global intent (no parent; not attached to any component tree)
 *   const i = await komponentor.runIntent("service/worker.html", { task: "sync" });
 */(function(a){"use strict";const p=a.jQuery||null,_="__kp_instance__",m="__kp_mounting__";function x(n){return n&&typeof n=="object"&&n.constructor===Object}function q(n=""){return n+Math.random().toString(36).slice(2,9)+"_"+Math.random().toString(36).slice(2,7)}function d(n){if(!n)throw new Error("Invalid host");if(typeof n=="string"){const t=document.querySelector(n);if(!t)throw new Error(`Host not found: ${n}`);return t}if(p&&n instanceof p)return n[0];if(n instanceof Element)return n;throw new Error("Invalid host type")}function E(n){return n&&n[_]||null}function A(n,t){n[_]=t}function C(n,t){n&&n[_]===t&&(n[_]=null)}function O(n,t){return n[m]?!1:(n[m]=t||!0,!0)}function b(n,t){n&&(n[m]===t||t==null)&&(n[m]=null)}function g(n){const t={url:"",data:{}};if(!n)return t;const e=String(n).split("|");return t.url=e.shift()||"",e.forEach(r=>{if(!r)return;const s=r.indexOf("=");if(s===-1)t.data[r]=null;else{const i=r.slice(0,s),o=r.slice(s+1);t.data[i]=o===""?"":o}}),t}function I(n){return!n||!String(n).toLowerCase().startsWith("data-")?null:String(n).slice(5).replace(/-([a-z])/g,(t,e)=>e.toUpperCase())}function S(n,t){if(!n||!n.dataset)return{};const e=I(t),r={};for(const s in n.dataset)s!==e&&(r[s]=n.dataset[s]);return r}class T{constructor(){this._map=new Map}on(t,e,r){if(typeof e!="function")return;const s=this._map.get(t)||[];s.push({fn:e,ctx:r||null}),this._map.set(t,s)}off(t,e,r){const s=this._map.get(t);s&&this._map.set(t,s.filter(i=>!(i.fn===e&&(r==null||i.ctx===r))))}emit(t,e,r){const s=this._map.get(t);if(!(!s||!s.length))for(const i of s.slice())try{i.fn.call(i.ctx||r||null,e)}catch{}}clear(){this._map.clear()}}class v{constructor(t,e){this.id=q("k_"),this.owner=t,this.manager=e,this.parent=null,this.children=[],this.ready=!1,this._destroyed=!1,this._state="initial",this._bus=new T,this._destroyers=[],this._req={token:0,ctrl:null}}get state(){return this._state}set state(t){this._state=t,this.trigger("state:change",{state:t,ctx:this}),this.trigger(`state:${t}`,this)}on(t,e,r){return this._bus.on(t,e,r||this),this}off(t,e,r){return this._bus.off(t,e,r||this),this}trigger(t,e){return this._bus.emit(t,e,this),this}emitUp(t,e){let r=this.parent;for(;r;)r.trigger(t,e),r=r.parent;return this}emitRoot(t,e){const r=this.manager&&this.manager._rootCtx?this.manager._rootCtx:null;return r&&r.trigger(t,e),this}onDestroy(t){return typeof t=="function"&&this._destroyers.push(t),this}requestAbort(){try{this._req.ctrl&&this._req.ctrl.abort()}catch{}this._req.ctrl=null}async requestText(t,e={}){this._req.token+=1;const r=this._req.token;this.requestAbort();const s=new AbortController;this._req.ctrl=s;const i=await fetch(t,Object.assign({},e,{signal:s.signal}));if(this._destroyed||r!==this._req.token)return null;if(!i.ok)throw new Error(`HTTP ${i.status} ${i.statusText}`);const o=await i.text();return this._destroyed||r!==this._req.token?null:o}destroy(){if(this._destroyed)return;this._destroyed=!0,this.state="destroying",this.trigger("context:destroy",this),this.requestAbort();const t=this.children.slice();this.children=[];for(const r of t)try{r&&typeof r.destroy=="function"&&r.destroy()}catch{}const e=this._destroyers.slice().reverse();this._destroyers=[];for(const r of e)try{r(this)}catch{}this._bus.clear(),this.ready=!1,this.state="destroyed"}}class l{constructor(t,e,r){if(this.manager=t,this.hostEl=d(e),this.$host=p?p(this.hostEl):null,this.opts=t._normalizeOpts(r),this.url=this.opts.url||"",this.data=this.opts.data||{},this.parent=this.opts.parent||null,this.children=[],this._scanned=!1,this._destroyed=!1,!O(this.hostEl,this)){const s=E(this.hostEl);if(s)return s;if(t.config.debug)throw new Error("Host is already mounting (concurrent mount detected).")}A(this.hostEl,this),this.ctx=new v(this,t),this.parent&&(this.parent instanceof l||this.parent instanceof u)&&(this.parent.children.push(this),this.ctx.parent=this.parent.ctx,this.parent.ctx.children.push(this.ctx)),this.ctx.onDestroy(()=>{b(this.hostEl,this),C(this.hostEl,this)})}find(t){return this.hostEl.querySelector(t)}findAll(t){return Array.from(this.hostEl.querySelectorAll(t))}async mount(){if(this._destroyed)return this;this.ctx.state="loading";try{this.opts.overlay!==!1&&this.manager.overlay.show(this);const t=this.manager._resolveUrl(this.url),e=await this.ctx.requestText(t,this.manager.config.fetchOptions||{});if(e==null)return this;const{fragment:r,init:s}=this.manager._parseHtml(e,this);this.ctx.state="rendering",this.manager._renderIntoHost(this,r),this.ctx.state="init",typeof s=="function"&&await s(this,this.data),this.ctx.ready=!0,this.ctx.state="ready",this.opts.autoload!==!1&&this.scan({replaceExisting:this.opts.replaceExistingChildren===!0})}catch(t){this.ctx.state="error",this.manager._renderError(this,t),this.manager.config.debug&&this.manager.log("mount error",t)}finally{this.manager.overlay.hide(this),b(this.hostEl,this)}return this}scan({replaceExisting:t=!1}={}){return this._destroyed?this:this._scanned&&t!==!0?this:(this._scanned=!0,this.manager.scan(this.hostEl,{parent:this,replaceExisting:t}),this)}async remount(){return this._destroyed?this:(this.destroy(),this.manager.mount(this.hostEl,Object.assign({},this.opts,{replace:!0})))}destroy(){if(this._destroyed)return;this._destroyed=!0;const t=this.children.slice();this.children=[];for(const e of t)try{e.destroy()}catch{}try{this.ctx.destroy()}catch{}try{this.hostEl.innerHTML=""}catch{}if(this.parent&&this.parent.children){const e=this.parent.children.indexOf(this);e!==-1&&this.parent.children.splice(e,1)}}}class u{constructor(t,e){this.manager=t,e=t._normalizeIntentOpts(e),this.url=e.url||"",this.data=e.data||{},this.parent=e.parent||null,this.children=[],this.hostEl=null,this.ctx=new v(this,t),this.parent&&(this.parent instanceof l||this.parent instanceof u)&&(this.parent.children.push(this),this.ctx.parent=this.parent.ctx,this.parent.ctx.children.push(this.ctx))}async run(){if(this.ctx._destroyed)return this;if(!this.url)return this.ctx.state="error",this.manager.config.debug&&this.manager.log("intent run: no url"),this;this.ctx.state="loading",this.manager.config.debug&&this.manager.log("intent run",this.url);try{const t=this.manager._resolveUrl(this.url),e=await this.ctx.requestText(t,this.manager.config.fetchOptions||{});if(e==null)return this;const{fragment:r,init:s}=this.manager._parseHtml(e,this);this.hostEl=r.cloneNode(!0),console.log("hostEl",this.hostEl),this.ctx.state="init",typeof s=="function"&&await s(this,this.data),this.ctx.ready=!0,this.ctx.state="ready"}catch(t){this.ctx.state="error",this.manager.config.debug&&this.manager.log("intent run error",this.url,t)}return this}destroy(){const t=this.children.slice();this.children=[];for(const e of t)try{e&&typeof e.destroy=="function"&&e.destroy()}catch{}try{this.ctx.destroy()}catch{}if(this.parent&&this.parent.children){const e=this.parent.children.indexOf(this);e!==-1&&this.parent.children.splice(e,1)}}}class H{constructor(t){this.manager=t,this._started=!1,this._handler=null,this.routes=[],this.outlet=null,this.notFound=null}_compile(t){const e=[];let r="^"+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r=r.replace(/\\:([a-zA-Z0-9_]+)/g,(s,i)=>(e.push(i),"([^/]+)")),r+="$",{regex:new RegExp(r),keys:e}}configure({outlet:t="#app",routes:e={},notFound:r=null}={}){return this.outlet=t,this.notFound=r,this.routes=[],Array.isArray(e)?e.forEach(s=>this.add(s.path,s.url)):Object.entries(e).forEach(([s,i])=>this.add(s,i)),this}add(t,e){const r=this._compile(t);return this.routes.push({pattern:t,keys:r.keys,regex:r.regex,url:e}),this}match(t){for(const e of this.routes){const r=e.regex.exec(t);if(!r)continue;const s={};return e.keys.forEach((i,o)=>s[i]=r[o+1]),{url:e.url,route:{hash:t,params:s}}}return null}start(){this._started||(this._started=!0,this._handler=()=>{const t=a.location.hash||"#/",e=this.match(t),r=d(this.outlet);if(!e){this.notFound&&this.manager.mount(r,{url:this.notFound,data:{route:{hash:t,params:{}}},replace:!0,parent:null});return}this.manager.mount(r,{url:e.url,data:{route:e.route},replace:!0,parent:null})},a.addEventListener("hashchange",this._handler),a.addEventListener("load",this._handler),this._handler())}stop(){this._started&&(this._started=!1,this._handler&&(a.removeEventListener("hashchange",this._handler),a.removeEventListener("load",this._handler)),this._handler=null)}navigate(t){a.location.hash=t}}class w{constructor(t={}){this.config=Object.assign({debug:!1,baseUrl:null,overlayClass:"komponent-overlay",overlayHtml:"<div style='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)'>Loading</div>",markerAttr:"data-komponent",errorHtml:(e,r)=>`<div style="padding:8px;border:1px solid #c00;background:#fee">Failed to load <b>${e}</b></div>`},t),this._root=null,this._rootCtx=null,this.router=new H(this),this.overlay={show:e=>this._overlayShow(e),hide:e=>this._overlayHide(e)}}log(...t){this.config.debug&&console.log("[komponentor]",...t)}_normalizeOpts(t){if(typeof t=="string")return{url:t,data:{},replace:!1,autoload:!0,overlay:!0};if(!x(t))return{url:"",data:{},replace:!1,autoload:!0,overlay:!0};const e=Object.assign({url:"",data:{},replace:!1,autoload:!0,overlay:!0,parent:null},t);if(typeof e.url=="string"&&e.url.includes("|")){const r=g(e.url);e.url=r.url,e.data=Object.assign({},r.data,e.data||{})}return e}_normalizeIntentOpts(t){let e="",r={},s=null;if(typeof t=="string"){const i=g(t);e=i.url,r=Object.assign({},i.data)}else if(x(t)){const i=t;e=i.url||"";const o=e&&e.includes("|")?g(e).data:{};r=Object.assign({},o,i.data||{}),s=i.parent!=null?i.parent:null}return{url:e,data:r,parent:s}}_resolveUrl(t){return t&&(this.config.baseUrl&&t[0]==="/"?this.config.baseUrl+t:t)}_parseHtml(t,e){const r=document.createElement("template");r.innerHTML=String(t);const s=Array.from(r.content.querySelectorAll("script")),i=s.map(c=>c.textContent||"").join(`
`);s.forEach(c=>c.remove());const o=r.content;let h=null;if(i.trim())try{const f=new Function("komponent","data","komponentor",`
              "use strict";
              ${i}
              // if code declared function init_komponent, it will overwrite our local binding only if it was declared as var/let assignment.
              // to support "function init_komponent(...) {}", we detect it via Function constructor scope:
              return (typeof init_komponent === "function") ? init_komponent : null;
            `)(e,e.data,this);typeof f=="function"&&(h=f)}catch(c){this.config.debug&&this.log("init parse error",c)}return{fragment:o,init:h}}_renderIntoHost(t,e){const r=t.hostEl;r.innerHTML="",r.appendChild(e.cloneNode(!0))}_renderError(t,e){try{t.hostEl.innerHTML=this.config.errorHtml(t.url,e)}catch{}}_overlayShow(t){const e=t.hostEl;if(!e||t._overlayEl&&t._overlayEl.parentNode)return;const r=document.createElement("div");r.className=this.config.overlayClass,r.innerHTML=this.config.overlayHtml,r.style.position="relative",r.style.minHeight="30px",r.style.border="1px dashed silver",r.style.background="#eee",r.style.zIndex="999999",t._overlayEl=r,e.insertBefore(r,e.firstChild)}_overlayHide(t){const e=t._overlayEl;e&&e.parentNode&&e.parentNode.removeChild(e),t._overlayEl=null}root(t,e){const r=d(t);if(this._root){try{this._root.destroy()}catch{}this._root=null,this._rootCtx=null}const s=this.mount(r,Object.assign({},this._normalizeOpts(e),{replace:!0,parent:null}));return this._root=s,this._rootCtx=s&&s.ctx?s.ctx:null,s}mount(t,e){const r=d(t),s=this._normalizeOpts(e),i=E(r);if(i&&i instanceof l&&s.replace&&i.destroy(),i&&!s.replace)return i;const o=new l(this,r,s);return o.mount(),o}scan(t=document.body,{parent:e=null,replaceExisting:r=!1}={}){const s=d(t),i=this.config.markerAttr,o=Array.from(s.querySelectorAll(`[${i}]`));for(const h of o){const c=h.getAttribute(i)||"",f=g(c),j=S(h,i),z=Object.assign({},f.data,j),k=E(h);if(!(k&&!r)){if(k&&r)try{k.destroy()}catch{}this.mount(h,{url:f.url,data:z,parent:e,replace:!0})}}}route({outlet:t="#app",routes:e={},notFound:r=null}={}){this.router.configure({outlet:t,routes:e,notFound:r}).start()}navigate(t){this.router.navigate(t)}intent(t){const e=this,r=e._normalizeIntentOpts(t);let s=r.url,i=Object.assign({},r.data);return{data(o,h){return console.log("data",o,h),o!=null&&typeof o=="object"?(console.log("objOrKey",o),Object.assign(i,o)):o!=null&&(i[o]=h),this},async send({parent:o}={}){const h=new u(e,{url:s,data:i,parent:o});return await h.run(),h}}}async runIntent(t,e,{parent:r}={}){const s=this._normalizeIntentOpts({url:t,data:e}),i=new u(this,{url:s.url,data:s.data,parent:r});return await i.run(),i}}const y=a.komponentor=a.komponentor||{};if(!(y instanceof w)){const n=new w(y&&x(y)?y:{});a.komponentor=n}a.komponentor.Komponentor=w,a.komponentor.Komponent=l,a.komponentor.Context=v,a.komponentor.HashRouter=H,a.komponentor.Intent=u})(window);})();
//# sourceMappingURL=komponentor.min.js.map
