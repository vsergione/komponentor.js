/*! komponentor v1.0.0
 * A jQuery plugin to create modular web apps
 * (c) 2026 
 * Released under the MIT License
 */
/*!
 * Komponentor (single-file)
 * - Tree of components (parent/children), local scan
 * - Destroy cascades
 * - Optional hash router
 * - jQuery optional (used only as helper if present)
 *
 * Public API (minimal):
 *   komponentor.root(host, urlOrOpts)
 *   komponentor.mount(host, urlOrOpts)
 *   komponentor.scan(container?, { parent?, replaceExisting? })
 *   komponentor.route({ outlet, routes, notFound })
 *   komponentor.navigate(hash)
 *   komponentor.intent(urlOrOpts)  -> fluent .data(...).send({ parent })
 *   komponentor.runIntent(url, data, { parent })
 *
 * Component marker:
 *   <div data-komponent="/path/to/component.html|id=5|foo=bar"></div>
 *
 * Intent usage examples:
 *   // From a component (intent becomes part of the branch; destroyed when parent is destroyed)
 *   async function init_komponent(k, data) {
 *     const i = await komponentor.intent("modal.html|id=1").data({ source: k }).send({ parent: k });
 *     // i.ctx.ready, i.data; i may mount DOM via komponentor.mount(...) inside modal's init
 *   }
 *
 *   // Global intent (no parent; not attached to any component tree)
 *   const i = await komponentor.runIntent("service/worker.html", { task: "sync" });
 */
!function(t){"use strict";const e=t.jQuery||null,r="__kp_instance__",s="__kp_mounting__";function n(t){return t&&"object"==typeof t&&t.constructor===Object}function i(t){if(!t)throw new Error("Invalid host");if("string"==typeof t){const e=document.querySelector(t);if(!e)throw new Error(`Host not found: ${t}`);return e}if(e&&t instanceof e)return t[0];if(t instanceof Element)return t;throw new Error("Invalid host type")}function o(t){return t&&t[r]||null}function a(t,e){t&&(t[s]!==e&&null!=e||(t[s]=null))}function h(t){const e={url:"",data:{}};if(!t)return e;const r=String(t).split("|");return e.url=r.shift()||"",r.forEach((t=>{if(!t)return;const r=t.indexOf("=");if(-1===r)e.data[t]=null;else{const s=t.slice(0,r),n=t.slice(r+1);e.data[s]=""===n?"":n}})),e}function l(t,e){if(!t||!t.dataset)return{};const r=(s=e)&&String(s).toLowerCase().startsWith("data-")?String(s).slice(5).replace(/-([a-z])/g,((t,e)=>e.toUpperCase())):null;var s;const n={};for(const e in t.dataset)e!==r&&(n[e]=t.dataset[e]);return n}class c{constructor(){this._map=new Map}on(t,e,r){if("function"!=typeof e)return;const s=this._map.get(t)||[];s.push({fn:e,ctx:r||null}),this._map.set(t,s)}off(t,e,r){const s=this._map.get(t);s&&this._map.set(t,s.filter((t=>!(t.fn===e&&(null==r||t.ctx===r)))))}emit(t,e,r){const s=this._map.get(t);if(s&&s.length)for(const t of s.slice())try{t.fn.call(t.ctx||r||null,e)}catch(t){}}clear(){this._map.clear()}}class u{constructor(t,e){this.id=function(t=""){return t+Math.random().toString(36).slice(2,9)+"_"+Math.random().toString(36).slice(2,7)}("k_"),this.owner=t,this.manager=e,this.parent=null,this.children=[],this.ready=!1,this._destroyed=!1,this._state="initial",this._bus=new c,this._destroyers=[],this._req={token:0,ctrl:null}}get state(){return this._state}set state(t){this._state=t,this.trigger("state:change",{state:t,ctx:this}),this.trigger(`state:${t}`,this)}on(t,e,r){return this._bus.on(t,e,r||this),this}off(t,e,r){return this._bus.off(t,e,r||this),this}trigger(t,e){return this._bus.emit(t,e,this),this}emitUp(t,e){let r=this.parent;for(;r;)r.trigger(t,e),r=r.parent;return this}emitRoot(t,e){const r=this.manager&&this.manager._rootCtx?this.manager._rootCtx:null;return r&&r.trigger(t,e),this}onDestroy(t){return"function"==typeof t&&this._destroyers.push(t),this}requestAbort(){try{this._req.ctrl&&this._req.ctrl.abort()}catch(t){}this._req.ctrl=null}async requestText(t,e={}){this._req.token+=1;const r=this._req.token;this.requestAbort();const s=new AbortController;this._req.ctrl=s;const n=await fetch(t,Object.assign({},e,{signal:s.signal}));if(this._destroyed)return null;if(r!==this._req.token)return null;if(!n.ok)throw new Error(`HTTP ${n.status} ${n.statusText}`);const i=await n.text();return this._destroyed||r!==this._req.token?null:i}destroy(){if(this._destroyed)return;this._destroyed=!0,this.state="destroying",this.trigger("context:destroy",this),this.requestAbort();const t=this.children.slice();this.children=[];for(const e of t)try{e&&"function"==typeof e.destroy&&e.destroy()}catch(t){}const e=this._destroyers.slice().reverse();this._destroyers=[];for(const t of e)try{t(this)}catch(t){}this._bus.clear(),this.ready=!1,this.state="destroyed"}}class d{constructor(t,n,h){if(this.manager=t,this.hostEl=i(n),this.$host=e?e(this.hostEl):null,this.opts=t._normalizeOpts(h),this.url=this.opts.url||"",this.data=this.opts.data||{},this.parent=this.opts.parent||null,this.children=[],this._scanned=!1,this._destroyed=!1,l=this.hostEl,c=this,l[s]||(l[s]=c||!0,0)){const e=o(this.hostEl);if(e)return e;if(t.config.debug)throw new Error("Host is already mounting (concurrent mount detected).")}var l,c;!function(t,e){t[r]=e}(this.hostEl,this),this.ctx=new u(this,t),this.parent&&(this.parent instanceof d||this.parent instanceof p)&&(this.parent.children.push(this),this.ctx.parent=this.parent.ctx,this.parent.ctx.children.push(this.ctx)),this.ctx.onDestroy((()=>{a(this.hostEl,this),function(t,e){t&&t[r]===e&&(t[r]=null)}(this.hostEl,this)}))}find(t){return this.hostEl.querySelector(t)}findAll(t){return Array.from(this.hostEl.querySelectorAll(t))}async mount(){if(this._destroyed)return this;this.ctx.state="loading";try{!1!==this.opts.overlay&&this.manager.overlay.show(this);const t=this.manager._resolveUrl(this.url),e=await this.ctx.requestText(t,this.manager.config.fetchOptions||{});if(null==e)return this;const{fragment:r,init:s}=this.manager._parseHtml(e,this);this.ctx.state="rendering",this.manager._renderIntoHost(this,r),this.ctx.state="init","function"==typeof s&&await s(this,this.data),this.ctx.ready=!0,this.ctx.state="ready",!1!==this.opts.autoload&&this.scan({replaceExisting:!0===this.opts.replaceExistingChildren})}catch(t){this.ctx.state="error",this.manager._renderError(this,t),this.manager.config.debug&&this.manager.log("mount error",t)}finally{this.manager.overlay.hide(this),a(this.hostEl,this)}return this}scan({replaceExisting:t=!1}={}){return this._destroyed||this._scanned&&!0!==t||(this._scanned=!0,this.manager.scan(this.hostEl,{parent:this,replaceExisting:t})),this}async remount(){return this._destroyed?this:(this.destroy(),this.manager.mount(this.hostEl,Object.assign({},this.opts,{replace:!0})))}destroy(){if(this._destroyed)return;this._destroyed=!0;const t=this.children.slice();this.children=[];for(const e of t)try{e.destroy()}catch(t){}try{this.ctx.destroy()}catch(t){}try{this.hostEl.innerHTML=""}catch(t){}if(this.parent&&this.parent.children){const t=this.parent.children.indexOf(this);-1!==t&&this.parent.children.splice(t,1)}}}class p{constructor(t,e){this.manager=t,e=t._normalizeIntentOpts(e),this.url=e.url||"",this.data=e.data||{},this.parent=e.parent||null,this.children=[],this.hostEl=null,this.ctx=new u(this,t),this.parent&&(this.parent instanceof d||this.parent instanceof p)&&(this.parent.children.push(this),this.ctx.parent=this.parent.ctx,this.parent.ctx.children.push(this.ctx))}async run(){if(this.ctx._destroyed)return this;if(!this.url)return this.ctx.state="error",this.manager.config.debug&&this.manager.log("intent run: no url"),this;this.ctx.state="loading",this.manager.config.debug&&this.manager.log("intent run",this.url);try{const t=this.manager._resolveUrl(this.url),e=await this.ctx.requestText(t,this.manager.config.fetchOptions||{});if(null==e)return this;const{fragment:r,init:s}=this.manager._parseHtml(e,this);this.hostEl=r.cloneNode(!0),console.log("hostEl",this.hostEl),this.ctx.state="init","function"==typeof s&&await s(this,this.data),this.ctx.ready=!0,this.ctx.state="ready"}catch(t){this.ctx.state="error",this.manager.config.debug&&this.manager.log("intent run error",this.url,t)}return this}destroy(){const t=this.children.slice();this.children=[];for(const e of t)try{e&&"function"==typeof e.destroy&&e.destroy()}catch(t){}try{this.ctx.destroy()}catch(t){}if(this.parent&&this.parent.children){const t=this.parent.children.indexOf(this);-1!==t&&this.parent.children.splice(t,1)}}}class f{constructor(t){this.manager=t,this._started=!1,this._handler=null,this.routes=[],this.outlet=null,this.notFound=null}_compile(t){const e=[];let r="^"+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r=r.replace(/\\:([a-zA-Z0-9_]+)/g,((t,r)=>(e.push(r),"([^/]+)"))),r+="$",{regex:new RegExp(r),keys:e}}configure({outlet:t="#app",routes:e={},notFound:r=null}={}){return this.outlet=t,this.notFound=r,this.routes=[],Array.isArray(e)?e.forEach((t=>this.add(t.path,t.url))):Object.entries(e).forEach((([t,e])=>this.add(t,e))),this}add(t,e){const r=this._compile(t);return this.routes.push({pattern:t,keys:r.keys,regex:r.regex,url:e}),this}match(t){for(const e of this.routes){const r=e.regex.exec(t);if(!r)continue;const s={};return e.keys.forEach(((t,e)=>s[t]=r[e+1])),{url:e.url,route:{hash:t,params:s}}}return null}start(){this._started||(this._started=!0,this._handler=()=>{const e=t.location.hash||"#/",r=this.match(e),s=i(this.outlet);r?this.manager.mount(s,{url:r.url,data:{route:r.route},replace:!0,parent:null}):this.notFound&&this.manager.mount(s,{url:this.notFound,data:{route:{hash:e,params:{}}},replace:!0,parent:null})},t.addEventListener("hashchange",this._handler),t.addEventListener("load",this._handler),this._handler())}stop(){this._started&&(this._started=!1,this._handler&&(t.removeEventListener("hashchange",this._handler),t.removeEventListener("load",this._handler)),this._handler=null)}navigate(e){t.location.hash=e}}class g{constructor(t={}){this.config=Object.assign({debug:!1,baseUrl:null,overlayClass:"komponent-overlay",overlayHtml:"<div style='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)'>Loading</div>",markerAttr:"data-komponent",errorHtml:(t,e)=>`<div style="padding:8px;border:1px solid #c00;background:#fee">Failed to load <b>${t}</b></div>`},t),this._root=null,this._rootCtx=null,this.router=new f(this),this.overlay={show:t=>this._overlayShow(t),hide:t=>this._overlayHide(t)}}log(...t){this.config.debug&&console.log("[komponentor]",...t)}_normalizeOpts(t){if("string"==typeof t)return{url:t,data:{},replace:!1,autoload:!0,overlay:!0};if(!n(t))return{url:"",data:{},replace:!1,autoload:!0,overlay:!0};const e=Object.assign({url:"",data:{},replace:!1,autoload:!0,overlay:!0,parent:null},t);if("string"==typeof e.url&&e.url.includes("|")){const t=h(e.url);e.url=t.url,e.data=Object.assign({},t.data,e.data||{})}return e}_normalizeIntentOpts(t){let e="",r={},s=null;if("string"==typeof t){const s=h(t);e=s.url,r=Object.assign({},s.data)}else if(n(t)){const n=t;e=n.url||"";const i=e&&e.includes("|")?h(e).data:{};r=Object.assign({},i,n.data||{}),s=null!=n.parent?n.parent:null}return{url:e,data:r,parent:s}}_resolveUrl(t){return t&&this.config.baseUrl&&"/"===t[0]?this.config.baseUrl+t:t}_parseHtml(t,e){const r=document.createElement("template");r.innerHTML=String(t);const s=Array.from(r.content.querySelectorAll("script")),n=s.map((t=>t.textContent||"")).join("\n");s.forEach((t=>t.remove()));const i=r.content;let o=null;if(n.trim())try{const t=new Function("komponent","data","komponentor",`\n              "use strict";\n              ${n}\n              // if code declared function init_komponent, it will overwrite our local binding only if it was declared as var/let assignment.\n              // to support "function init_komponent(...) {}", we detect it via Function constructor scope:\n              return (typeof init_komponent === "function") ? init_komponent : null;\n            `)(e,e.data,this);"function"==typeof t&&(o=t)}catch(t){this.config.debug&&this.log("init parse error",t)}return{fragment:i,init:o}}_renderIntoHost(t,e){const r=t.hostEl;r.innerHTML="",r.appendChild(e.cloneNode(!0))}_renderError(t,e){try{t.hostEl.innerHTML=this.config.errorHtml(t.url,e)}catch(t){}}_overlayShow(t){const e=t.hostEl;if(!e)return;if(t._overlayEl&&t._overlayEl.parentNode)return;const r=document.createElement("div");r.className=this.config.overlayClass,r.innerHTML=this.config.overlayHtml,r.style.position="relative",r.style.minHeight="30px",r.style.border="1px dashed silver",r.style.background="#eee",r.style.zIndex="999999",t._overlayEl=r,e.insertBefore(r,e.firstChild)}_overlayHide(t){const e=t._overlayEl;e&&e.parentNode&&e.parentNode.removeChild(e),t._overlayEl=null}root(t,e){const r=i(t);if(this._root){try{this._root.destroy()}catch(t){}this._root=null,this._rootCtx=null}const s=this.mount(r,Object.assign({},this._normalizeOpts(e),{replace:!0,parent:null}));return this._root=s,this._rootCtx=s&&s.ctx?s.ctx:null,s}mount(t,e){const r=i(t),s=this._normalizeOpts(e),n=o(r);if(n&&n instanceof d&&s.replace&&n.destroy(),n&&!s.replace)return n;const a=new d(this,r,s);return a.mount(),a}scan(t=document.body,{parent:e=null,replaceExisting:r=!1}={}){const s=i(t),n=this.config.markerAttr,a=Array.from(s.querySelectorAll(`[${n}]`));for(const t of a){const s=h(t.getAttribute(n)||""),i=l(t,n),a=Object.assign({},s.data,i),c=o(t);if(!c||r){if(c&&r)try{c.destroy()}catch(t){}this.mount(t,{url:s.url,data:a,parent:e,replace:!0})}}}route({outlet:t="#app",routes:e={},notFound:r=null}={}){this.router.configure({outlet:t,routes:e,notFound:r}).start()}navigate(t){this.router.navigate(t)}intent(t){const e=this,r=e._normalizeIntentOpts(t);let s=r.url,n=Object.assign({},r.data);return{data(t,e){return console.log("data",t,e),null!=t&&"object"==typeof t?(console.log("objOrKey",t),Object.assign(n,t)):null!=t&&(n[t]=e),this},async send({parent:t}={}){const r=new p(e,{url:s,data:n,parent:t});return await r.run(),r}}}async runIntent(t,e,{parent:r}={}){const s=this._normalizeIntentOpts({url:t,data:e}),n=new p(this,{url:s.url,data:s.data,parent:r});return await n.run(),n}}const y=t.komponentor=t.komponentor||{};if(!(y instanceof g)){const e=new g(y&&n(y)?y:{});t.komponentor=e}t.komponentor.Komponentor=g,t.komponentor.Komponent=d,t.komponentor.Context=u,t.komponentor.HashRouter=f,t.komponentor.Intent=p}(window);
//# sourceMappingURL=komponentor.min.js.map
