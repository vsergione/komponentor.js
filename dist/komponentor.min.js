/*! komponentor v1.0.0
 * A jQuery plugin to create modular web apps
 * (c) 2026 Sergiu Voicu (Logimaxx Systems SRL) https://logimaxx.ro
 * Released under the MIT License
 */

(()=>{/*!
 * Komponentor (single-file)
 * - Tree of components (parent/children), local scan
 * - Destroy cascades
 * - Optional hash router
 * - jQuery optional (used only as helper if present)
 *
 * Public API (minimal):
 *   komponentor.root(host, urlOrOpts)
 *   komponentor.mount(host, urlOrOpts)
 *   komponentor.scan(container?, { parent?, replaceExisting? })
 *   komponentor.route({ outlet, routes, notFound })
 *   komponentor.navigate(hash)
 *   komponentor.intent(urlOrOpts)  -> fluent .data(...).send({ parent })
 *   komponentor.runIntent(url, data, { parent })
 *
 * Mount option: replaceHost: true â€” replace the host element with the component root (host is removed; id is copied so e.g. #app still works). Destroy then removes the new root from DOM. remount() mounts onto the detached node unless you pass a new host.
 *
 * Component marker:
 *   <div data-komponent="/path/to/component.html|id=5|foo=bar"></div>
 *
 * Intent usage examples:
 *   // From a component (intent becomes part of the branch; destroyed when parent is destroyed)
 *   async function init_komponent(k, data) {
 *     const i = await komponentor.intent("modal.html|id=1").data({ source: k }).send({ parent: k });
 *     // i.ctx.ready, i.data; i may mount DOM via komponentor.mount(...) inside modal's init
 *   }
 *
 *   // Global intent (no parent; not attached to any component tree)
 *   const i = await komponentor.runIntent("service/worker.html", { task: "sync" });
 */(function(h){"use strict";const c=h.jQuery||null,_="__kp_instance__",y="__kp_mounting__";function x(i){return i&&typeof i=="object"&&i.constructor===Object}function q(i=""){return i+Math.random().toString(36).slice(2,9)+"_"+Math.random().toString(36).slice(2,7)}function f(i){if(!i)throw new Error("Invalid host");if(typeof i=="string"){const t=document.querySelector(i);if(!t)throw new Error(`Host not found: ${i}`);return t}if(c&&i instanceof c)return i[0];if(i instanceof Element)return i;throw new Error("Invalid host type")}function E(i){return i&&i[_]||null}function H(i,t){i[_]=t}function v(i,t){i&&i[_]===t&&(i[_]=null)}function O(i,t){return i[y]?!1:(i[y]=t||!0,!0)}function C(i,t){i&&(i[y]===t||t==null)&&(i[y]=null)}function m(i){const t={url:"",data:{}};if(!i)return t;const e=String(i).split("|");return t.url=e.shift()||"",e.forEach(r=>{if(!r)return;const s=r.indexOf("=");if(s===-1)t.data[r]=null;else{const n=r.slice(0,s),o=r.slice(s+1);t.data[n]=o===""?"":o}}),t}function I(i){return!i||!String(i).toLowerCase().startsWith("data-")?null:String(i).slice(5).replace(/-([a-z])/g,(t,e)=>e.toUpperCase())}function S(i,t){if(!i||!i.dataset)return{};const e=I(t),r={};for(const s in i.dataset)s!==e&&(r[s]=i.dataset[s]);return r}class T{constructor(){this._map=new Map}on(t,e,r){if(typeof e!="function")return;const s=this._map.get(t)||[];s.push({fn:e,ctx:r||null}),this._map.set(t,s)}off(t,e,r){const s=this._map.get(t);s&&this._map.set(t,s.filter(n=>!(n.fn===e&&(r==null||n.ctx===r))))}emit(t,e,r){const s=this._map.get(t);if(!(!s||!s.length))for(const n of s.slice())try{n.fn.call(n.ctx||r||null,e)}catch{}}clear(){this._map.clear()}}class w{constructor(t,e){this.id=q("k_"),this.owner=t,this.manager=e,this.parent=null,this.children=[],this.ready=!1,this._destroyed=!1,this._state="initial",this._bus=new T,this._destroyers=[],this._req={token:0,ctrl:null}}get state(){return this._state}set state(t){this._state=t,this.trigger("state:change",{state:t,ctx:this}),this.trigger(`state:${t}`,this)}on(t,e,r){return this._bus.on(t,e,r||this),this}off(t,e,r){return this._bus.off(t,e,r||this),this}trigger(t,e){return this._bus.emit(t,e,this),this}emitUp(t,e){let r=this.parent;for(;r;)r.trigger(t,e),r=r.parent;return this}emitRoot(t,e){const r=this.manager&&this.manager._rootCtx?this.manager._rootCtx:null;return r&&r.trigger(t,e),this}onDestroy(t){return typeof t=="function"&&this._destroyers.push(t),this}requestAbort(){try{this._req.ctrl&&this._req.ctrl.abort()}catch{}this._req.ctrl=null}async requestText(t,e={}){this._req.token+=1;const r=this._req.token;this.requestAbort();const s=new AbortController;this._req.ctrl=s;const n=await fetch(t,Object.assign({},e,{signal:s.signal}));if(this._destroyed||r!==this._req.token)return null;if(!n.ok)throw new Error(`HTTP ${n.status} ${n.statusText}`);const o=await n.text();return this._destroyed||r!==this._req.token?null:o}destroy(){if(this._destroyed)return;this._destroyed=!0,this.state="destroying",this.trigger("context:destroy",this),this.requestAbort();const t=this.children.slice();this.children=[];for(const r of t)try{r&&typeof r.destroy=="function"&&r.destroy()}catch{}const e=this._destroyers.slice().reverse();this._destroyers=[];for(const r of e)try{r(this)}catch{}this._bus.clear(),this.ready=!1,this.state="destroyed"}}class u{constructor(t,e,r){if(this.manager=t,this.hostEl=f(e),this.$host=c?c(this.hostEl):null,this.opts=t._normalizeOpts(r),this.url=this.opts.url||"",this.data=this.opts.data||{},this.parent=this.opts.parent||null,this.children=[],this._scanned=!1,this._destroyed=!1,!O(this.hostEl,this)){const s=E(this.hostEl);if(s)return s;if(t.config.debug)throw new Error("Host is already mounting (concurrent mount detected).")}H(this.hostEl,this),this.ctx=new w(this,t),this.parent&&(this.parent instanceof u||this.parent instanceof d)&&(this.parent.children.push(this),this.ctx.parent=this.parent.ctx,this.parent.ctx.children.push(this.ctx)),this.ctx.onDestroy(()=>{C(this.hostEl,this),v(this.hostEl,this)})}find(t){return this.hostEl.querySelector(t)}findAll(t){return Array.from(this.hostEl.querySelectorAll(t))}async mount(){if(this._destroyed)return this;this.ctx.state="loading";try{this.opts.overlay!==!1&&this.manager.overlay.show(this);const t=this.manager._resolveUrl(this.url),e=await this.ctx.requestText(t,this.manager.config.fetchOptions||{});if(e==null)return this;const{fragment:r,init:s}=this.manager._parseHtml(e,this);this.ctx.state="rendering",this.manager._renderIntoHost(this,r),this.ctx.state="init",typeof s=="function"&&await s(this,this.data),this.ctx.ready=!0,this.ctx.state="ready",this.opts.autoload!==!1&&this.scan({replaceExisting:this.opts.replaceExistingChildren===!0})}catch(t){this.ctx.state="error",this.manager._renderError(this,t),this.manager.config.debug&&this.manager.log("mount error",t)}finally{this.manager.overlay.hide(this),C(this.hostEl,this)}return this}scan({replaceExisting:t=!1}={}){return this._destroyed?this:this._scanned&&t!==!0?this:(this._scanned=!0,this.manager.scan(this.hostEl,{parent:this,replaceExisting:t}),this)}async remount(){return this._destroyed?this:(this.destroy(),this.manager.mount(this.hostEl,Object.assign({},this.opts,{replace:!0})))}destroy(){if(this._destroyed)return;this._destroyed=!0;const t=this.children.slice();this.children=[];for(const e of t)try{e.destroy()}catch{}try{this.ctx.destroy()}catch{}try{this.opts.replaceHost?(this.hostEl.parentNode&&this.hostEl.parentNode.removeChild(this.hostEl),v(this.hostEl,this)):this.hostEl.innerHTML=""}catch{}if(this.parent&&this.parent.children){const e=this.parent.children.indexOf(this);e!==-1&&this.parent.children.splice(e,1)}}}class d{constructor(t,e){this.manager=t,e=t._normalizeIntentOpts(e),this.url=e.url||"",this.data=e.data||{},this.parent=e.parent||null,this.children=[],this.hostEl=null,this.ctx=new w(this,t),this.parent&&(this.parent instanceof u||this.parent instanceof d)&&(this.parent.children.push(this),this.ctx.parent=this.parent.ctx,this.parent.ctx.children.push(this.ctx))}async run(){if(this.ctx._destroyed)return this;if(!this.url)return this.ctx.state="error",this.manager.log("intent run: no url"),this;this.ctx.state="loading",this.manager.log("intent run",this.url);try{const t=this.manager._resolveUrl(this.url),e=await this.ctx.requestText(t,this.manager.config.fetchOptions||{});if(e==null)return this;const{fragment:r,init:s}=this.manager._parseHtml(e,this);this.hostEl=r.cloneNode(!0),console.log("hostEl",this.hostEl),this.ctx.state="init",typeof s=="function"&&await s(this,this.data),this.ctx.ready=!0,this.ctx.state="ready"}catch(t){this.ctx.state="error",this.manager.config.debug&&this.manager.log("intent run error",this.url,t)}return this}destroy(){const t=this.children.slice();this.children=[];for(const e of t)try{e&&typeof e.destroy=="function"&&e.destroy()}catch{}try{this.ctx.destroy()}catch{}if(this.parent&&this.parent.children){const e=this.parent.children.indexOf(this);e!==-1&&this.parent.children.splice(e,1)}}}class A{constructor(t){this.manager=t,this._started=!1,this._handler=null,this.routes=[],this.outlet=null,this.notFound=null}_compile(t){const e=[];let r="^"+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r=r.replace(/\\:([a-zA-Z0-9_]+)/g,(s,n)=>(e.push(n),"([^/]+)")),r+="$",{regex:new RegExp(r),keys:e}}configure({outlet:t="#app",routes:e={},notFound:r=null}={}){return this.outlet=t,this.notFound=r,this.routes=[],Array.isArray(e)?e.forEach(s=>this.add(s.path,s.url)):Object.entries(e).forEach(([s,n])=>this.add(s,n)),this}add(t,e){const r=this._compile(t);return this.routes.push({pattern:t,keys:r.keys,regex:r.regex,url:e}),this}match(t){for(const e of this.routes){const r=e.regex.exec(t);if(!r)continue;const s={};return e.keys.forEach((n,o)=>s[n]=r[o+1]),{url:e.url,route:{hash:t,params:s}}}return null}start(){this._started||(this._started=!0,this._handler=()=>{const t=h.location.hash||"#/",e=this.match(t),r=f(this.outlet);if(!e){this.notFound&&this.manager.mount(r,{url:this.notFound,data:{route:{hash:t,params:{}}},replace:!0,parent:null});return}this.manager.mount(r,{url:e.url,data:{route:e.route},replace:!0,parent:null})},h.addEventListener("hashchange",this._handler),h.addEventListener("load",this._handler),this._handler())}stop(){this._started&&(this._started=!1,this._handler&&(h.removeEventListener("hashchange",this._handler),h.removeEventListener("load",this._handler)),this._handler=null)}navigate(t){h.location.hash=t}}class k{constructor(t={}){this.config=Object.assign({debug:!1,baseUrl:null,overlayClass:"komponent-overlay",overlayHtml:"<div style='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)'>Loading</div>",markerAttr:"data-komponent",errorHtml:(e,r)=>`<div style="padding:8px;border:1px solid #c00;background:#fee">Failed to load <b>${e}</b></div>`},t),this._root=null,this._rootCtx=null,this.router=new A(this),this.overlay={show:e=>this._overlayShow(e),hide:e=>this._overlayHide(e)}}log(...t){this.config.debug&&console.log("[komponentor]",...t)}_normalizeOpts(t){if(typeof t=="string")return{url:t,data:{},replace:!1,autoload:!0,overlay:!0};if(!x(t))return{url:"",data:{},replace:!1,autoload:!0,overlay:!0};const e=Object.assign({url:"",data:{},replace:!1,replaceHost:!1,autoload:!0,overlay:!0,parent:null},t);if(typeof e.url=="string"&&e.url.includes("|")){const r=m(e.url);e.url=r.url,e.data=Object.assign({},r.data,e.data||{})}return e}_normalizeIntentOpts(t){let e="",r={},s=null;if(typeof t=="string"){const n=m(t);e=n.url,r=Object.assign({},n.data)}else if(x(t)){const n=t;e=n.url||"";const o=e&&e.includes("|")?m(e).data:{};r=Object.assign({},o,n.data||{}),s=n.parent!=null?n.parent:null}return{url:e,data:r,parent:s}}_resolveUrl(t){return t&&(this.config.baseUrl&&t[0]==="/"?this.config.baseUrl+t:t)}_parseHtml(t,e){const r=document.createElement("template");r.innerHTML=String(t);const s=Array.from(r.content.querySelectorAll("script")),n=s.map(l=>l.textContent||"").join(`
`);s.forEach(l=>l.remove());const o=r.content;let a=null;if(n.trim())try{const p=new Function("komponent","data","komponentor",`
              "use strict";
              ${n}
              // if code declared function init_komponent, it will overwrite our local binding only if it was declared as var/let assignment.
              // to support "function init_komponent(...) {}", we detect it via Function constructor scope:
              return (typeof init_komponent === "function") ? init_komponent : null;
            `)(e,e.data,this);typeof p=="function"&&(a=p)}catch(l){this.config.debug&&this.log("init parse error",l)}return{fragment:o,init:a}}_renderIntoHost(t,e){const r=t.hostEl;if(t.opts.replaceHost){const s=r.parentNode;if(!s){this.config.debug&&this.log("replaceHost: host has no parent, falling back to append"),r.innerHTML="",r.appendChild(e.cloneNode(!0));return}const n=e.cloneNode(!0),o=n.children?Array.from(n.children):[];let a;if(o.length===1)a=o[0];else if(o.length===0)a=document.createElement("div");else for(a=document.createElement("div");n.firstChild;)a.appendChild(n.firstChild);r.id&&(a.id=r.id),s.replaceChild(a,r),v(r,t),H(a,t),t.hostEl=a,t.$host&&(t.$host=c?c(a):null)}else r.innerHTML="",r.appendChild(e.cloneNode(!0))}_renderError(t,e){try{t.hostEl.innerHTML=this.config.errorHtml(t.url,e)}catch{}}_overlayShow(t){const e=t.hostEl;if(!e||t._overlayEl&&t._overlayEl.parentNode)return;const r=document.createElement("div");r.className=this.config.overlayClass,r.innerHTML=this.config.overlayHtml,r.style.position="relative",r.style.minHeight="30px",r.style.border="1px dashed silver",r.style.background="#eee",r.style.zIndex="999999",t._overlayEl=r,e.insertBefore(r,e.firstChild)}_overlayHide(t){const e=t._overlayEl;e&&e.parentNode&&e.parentNode.removeChild(e),t._overlayEl=null}root(t,e){console.log("root",t);const r=f(t);if(console.log("el",r),this._root){try{this._root.destroy()}catch{}this._root=null,this._rootCtx=null}const s=this.mount(r,Object.assign({},this._normalizeOpts(e),{replace:!0,parent:null}));return this._root=s,this._rootCtx=s&&s.ctx?s.ctx:null,s}mount(t,e){const r=f(t),s=this._normalizeOpts(e),n=E(r);if(n&&n instanceof u&&s.replace&&n.destroy(),n&&!s.replace)return n;const o=new u(this,r,s);return o.mount(),o}scan(t=document.body,{parent:e=null,replaceExisting:r=!1}={}){const s=f(t),n=this.config.markerAttr,o=Array.from(s.querySelectorAll(`[${n}]`));for(const a of o){const l=a.getAttribute(n)||"",p=m(l),j=S(a,n),$=Object.assign({},p.data,j),b=E(a);if(!(b&&!r)){if(b&&r)try{b.destroy()}catch{}this.mount(a,{url:p.url,data:$,parent:e,replace:!0})}}}route({outlet:t="#app",routes:e={},notFound:r=null}={}){this.router.configure({outlet:t,routes:e,notFound:r}).start()}navigate(t){this.router.navigate(t)}intent(t){const e=this,r=e._normalizeIntentOpts(t);let s=r.url,n=Object.assign({},r.data);return{data(o,a){return o!=null&&typeof o=="object"?Object.assign(n,o):o!=null&&(n[o]=a),this},async send({parent:o}={}){const a=new d(e,{url:s,data:n,parent:o});return await a.run(),a}}}async runIntent(t,e,{parent:r}={}){const s=this._normalizeIntentOpts({url:t,data:e}),n=new d(this,{url:s.url,data:s.data,parent:r});return await n.run(),n}}const g=h.komponentor=h.komponentor||{};if(!(g instanceof k)){const i=new k(g&&x(g)?g:{});h.komponentor=i}h.komponentor.Komponentor=k,h.komponentor.Komponent=u,h.komponentor.Context=w,h.komponentor.HashRouter=A,h.komponentor.Intent=d})(window);})();
//# sourceMappingURL=komponentor.min.js.map
