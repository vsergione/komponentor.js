{"version":3,"sources":["kviews.js"],"names":["root","$","fn","Error","Handlebars","compileTemplate","html","compile","data","String","replace","_","path","parts","split","v","p","undefined","defaultCompile","KModel","views","destroyed","listeners","Map","props","this","val","_trigger","render","constructor","on","event","ctx","arr","get","push","set","off","filter","l","trigger","payload","length","slice","call","e","console","error","update","name","value","bindView","view","indexOf","setModel","unbindView","i","splice","unbindAllViews","forEach","destroy","model","clear","KView","compiled","el","lifecycle","$el","outerHTML","onDestroy","existingData","$content","replaceWith","attr","$error","getRoot","remove","getKModel","parents","window","globalThis","jQuery"],"mappings":"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","file":"kviews.min.js","sourcesContent":["/**\n * KViews - KModel + KView with template rendering.\n * Requires: jQuery.\n * Optional: Handlebars (window.Handlebars) for full syntax; otherwise uses built-in {{key}} / {{key.sub}} fallback.\n * No Komponentor dependency.\n */\n(function (root, $) {\n    \"use strict\";\n\n    if (!$ || typeof $.fn !== \"object\") {\n        throw new Error(\"kviews requires jQuery\");\n    }\n\n    const Handlebars = root.Handlebars;\n\n    /** Fallback when Handlebars is missing: {{key}} and {{key.sub}} only. */\n    function defaultCompile(html) {\n        return function (data) {\n            if (data == null) data = {};\n            return String(html).replace(/\\{\\{(\\w+(?:\\.\\w+)*)\\}\\}/g, (_, path) => {\n                const parts = path.split(\".\");\n                let v = data;\n                for (const p of parts) {\n                    v = v != null && typeof v === \"object\" ? v[p] : undefined;\n                }\n                return v != null ? String(v) : \"\";\n            });\n        };\n    }\n\n    function compileTemplate(html) {\n        if (Handlebars && typeof Handlebars.compile === \"function\") {\n            return Handlebars.compile(html);\n        }\n        return defaultCompile(html);\n    }\n    class KView {\n        #compiled;\n        #model;\n        #el;\n        #destroyed = false;\n\n        /**\n         * @param {jQuery|HTMLElement|string} el - Single element: mount point; its outerHTML is the template. Replaced by the rendered root on first render.\n         * @param {KModel} model - KModel instance.\n         * @param {Object} [lifecycle] - Optional object with onDestroy(fn); if provided, view.destroy() is called when lifecycle is torn down.\n         * @throws {Error} If el is not a single node.\n         */\n        constructor(el, lifecycle) {\n            const $el = $(el);\n            if ($el.length !== 1) {\n                throw new Error(\"KView: el must be a single node (got \" + $el.length + \")\");\n            }\n            this.#el = $el;\n            this.#compiled = compileTemplate($el[0].outerHTML);\n\n            if (lifecycle && typeof lifecycle.onDestroy === \"function\") {\n                lifecycle.onDestroy(() => this.destroy());\n            }\n        }\n\n        render() {\n            const existingData = this.#el.data(\"komponent\") || null;\n\n            if (this.#destroyed) return;\n            try {\n                const html = this.#compiled(this.#model.props);\n                const $content = $(html);\n\n                this.#el.replaceWith($content);\n                this.#el = $content;\n                this.#el.data(\"model\", this.#model).attr(\"is\",\"kview\");\n//                this.#el.find(\"*\").data(\"model\", this.#model);\n            } catch (e) {\n                const $error = $(\"<div>Error in KView.render</div>\");\n                this.#el.replaceWith($error);\n                this.#el = $error;\n                console.error(\"Error in KView.render\", e);\n            }\n\n            if (existingData != null) {\n                this.#el.data(\"komponent\", existingData);\n            }\n        }\n\n        /**\n         * Current root element(s) in the DOM. Before first render, returns the mount element; after, the rendered root.\n         * @returns {jQuery}\n         */\n        getRoot() {\n            return this.#el || $();\n        }\n\n        setModel(model) {\n            if (this.#destroyed) return;\n            this.#model = model;\n            this.render();\n        }\n\n        /**\n         * Unbind this view from the model and mark as destroyed. Removes the view root from the DOM.\n         */\n        destroy() {\n            if (this.#destroyed) return;\n            this.#destroyed = true;\n            if (this.#model && typeof this.#model.unbindView === \"function\") {\n                this.#model.unbindView(this);\n            }\n            if (this.#el && this.#el.length) this.#el.remove();\n            this.#model = null;\n            this.#el = null;\n        }\n    }\n\n    /**\n     * KModel - Observable data for use with KView.\n     * data / props, update(name, value), bindView(view), unbindView(view), render(), destroy().\n     * Events: \"change\" (after update or data set), \"view:bind\", \"view:unbind\", \"destroy\".\n     */\n    class KModel {\n        views = [];\n        #data = {};\n        #destroyed = false;\n        #listeners = new Map(); // event -> [{ fn, ctx }]\n\n        get props() {\n            return this.#data;\n        }\n\n        get data() {\n            return this.#data;\n        }\n\n        set data(val) {\n            if (this.#destroyed) return;\n            this.#data = val;\n            this._trigger(\"change\", { data: this.#data });\n            this.render();\n        }\n\n        constructor(data) {\n            this.#data = data || {};\n        }\n\n        /**\n         * Subscribe to an event. Events: \"change\", \"view:bind\", \"view:unbind\", \"destroy\".\n         * @param {string} event - Event name.\n         * @param {function} fn - Callback(payload).\n         * @param {*} [ctx] - Optional this for fn.\n         * @returns {KModel} this\n         */\n        on(event, fn, ctx) {\n            if (typeof fn !== \"function\") return this;\n            const arr = this.#listeners.get(event) || [];\n            arr.push({ fn, ctx: ctx || null });\n            this.#listeners.set(event, arr);\n            return this;\n        }\n\n        /**\n         * Unsubscribe from an event.\n         * @param {string} event - Event name.\n         * @param {function} fn - Same function reference as passed to on().\n         * @param {*} [ctx] - Optional context (must match on() to remove).\n         * @returns {KModel} this\n         */\n        off(event, fn, ctx) {\n            const arr = this.#listeners.get(event);\n            if (!arr) return this;\n            this.#listeners.set(\n                event,\n                arr.filter((l) => !(l.fn === fn && (ctx == null || l.ctx === ctx)))\n            );\n            return this;\n        }\n\n        /**\n         * Emit an event to all listeners.\n         * @param {string} event - Event name.\n         * @param {*} payload - Data passed to listeners.\n         * @returns {KModel} this\n         */\n        trigger(event, payload) {\n            const arr = this.#listeners.get(event);\n            if (!arr || !arr.length) return this;\n            for (const l of arr.slice()) {\n                try {\n                    l.fn.call(l.ctx || null, payload);\n                } catch (e) {\n                    console.error(\"KModel event handler error\", event, e);\n                }\n            }\n            return this;\n        }\n\n        _trigger(event, payload) {\n            this.trigger(event, payload);\n        }\n\n        update(name, val) {\n            if (this.#destroyed) return;\n            this.#data[name] = val;\n            this._trigger(\"change\", { name, value: val });\n            this.render();\n        }\n\n        bindView(view) {\n            if (this.#destroyed) return;\n            if (this.views.indexOf(view) === -1) {\n                this.views.push(view);\n                this._trigger(\"view:bind\", { view });\n            }\n            view.setModel(this);\n        }\n\n        unbindView(view) {\n            const i = this.views.indexOf(view);\n            if (i !== -1) {\n                this.views.splice(i, 1);\n                this._trigger(\"view:unbind\", { view });\n            }\n        }\n\n        unbindAllViews() {\n            this.views.length = 0;\n        }\n\n        render() {\n            if (this.#destroyed) return;\n            this.views.forEach((v) => v.render());\n        }\n\n        destroy() {\n            if (this.#destroyed) return;\n            this.#destroyed = true;\n            this._trigger(\"destroy\", { model: this });\n            this.views.forEach((v) => {\n                if (v && typeof v.destroy === \"function\") v.destroy();\n            });\n            this.views.length = 0;\n            this.#listeners.clear();\n            this.#data = {};\n        }\n    }\n\n    root.KModel = KModel;\n    root.KView = KView;\n    root.getKModel = function(el) {\n        return $(el).parents(\"[is=kview]\").data(\"model\");\n    }\n})(typeof window !== \"undefined\" ? window : globalThis, typeof window !== \"undefined\" && window.jQuery);\n"]}